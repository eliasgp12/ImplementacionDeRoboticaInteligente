clear
close all
clc

%% ===================== SIMULACIÓN CON PUNTOS REDONDEADOS ==========================

ts = 0.1;          % Paso de muestreo
v = 0.5;           % Velocidad lineal constante

%%%%%%%%%%%%%%%%%%%%%%%%%%%% PUNTOS DE TRAYECTORIA %%%%%%%%%%%%%%%%%%%%%%%%
waypoints = [
    -0.4692, -0.5266;
    -0.4555, -0.5971;
    -0.4172, -0.7120;
    -0.3862, -0.7685;
    -0.3388, -0.8196;
    -0.2922, -0.8696;
    -0.2399, -0.9132;
    -0.1950, -0.9692;
    -0.1515, -1.0078;
    -0.1166, -1.0352;
    -0.0618, -1.0651;
     0.0104, -1.0726;
     0.0727, -1.0701;
     0.1212, -1.0713;
     0.1785, -1.0701;
     0.2196, -1.0626;
     0.2694, -1.0452;
     0.3055, -1.0203;
     0.3404, -0.9941;
     0.3777, -0.9593;
     0.4188, -0.9132;
     0.4649, -0.8808;
     0.5010, -0.8447;
     0.5261, -0.8103;
     0.5484, -0.7823;
     0.5707, -0.7445;
     0.6000, -0.7000;
     0.6259, -0.6283;
     0.6501, -0.5228;
     0.6585, -0.4590;
     0.6838, -0.3613;
     0.6922, -0.2703;
     0.6905, -0.1676;
     0.6838, -0.0867;
     0.6765,  0.0368;
     0.6628,  0.1556;
     0.6101,  0.2732;
     0.5561,  0.3880;
     0.4953,  0.4605;
     0.3941,  0.5314;
     0.2877,  0.5787;
     0.1814,  0.6023;
     0.1342,  0.5837;
     0.0582,  0.5753;
    -0.0127,  0.5939;
    -0.0903,  0.5770;
    -0.2118,  0.5432;
    -0.3131,  0.5027;
    -0.3722,  0.4538;
    -0.4076,  0.3694;
    -0.4279,  0.3086;
    -0.4515,  0.2226;
    -0.4920,  0.1416;
    -0.5021,  0.0707;
    -0.5000,  0.0000;
    -0.5156, -0.0711;
    -0.5156, -0.1352;
    -0.5190, -0.1875;
    -0.5190, -0.2449;
    -0.5457, -0.2329;
    -0.5563, -0.1842;
    -0.5624, -0.1188;
    -0.5898, -0.0762;
    -0.6096, -0.1127;
    -0.6035, -0.1416;
    -0.5989, -0.1751;
    -0.5989, -0.2253;
    -0.5989, -0.2770;
    -0.5883, -0.3181;
    -0.5746, -0.3653;
    -0.5639, -0.3942;
    -0.5502, -0.4262;
    -0.5289, -0.4505;
    -0.4924, -0.4809;
    -0.4863, -0.4323;
    -0.4939, -0.3699;
    -0.5137, -0.2968;
    -0.6354, -0.2710;
    -0.6583, -0.2086;
    -0.6735, -0.1005;
    -0.7206,  0.0151;
   -0.7480,  0.0805;
   -0.8104,  0.1688;
   -0.7785,  0.2951;
   -0.7521,  0.4495;
   -0.6692,  0.5739;
   -0.5788,  0.7245;
   -0.4000,  0.8000;
   -0.2925,  0.8865;
   -0.1230,  0.9167;
    0.0616,  0.9732;
    0.1294,  0.9543;
    0.2651,  0.9543;
    0.4308,  0.9657;
    0.4986,  0.9506;
    0.5853,  0.8715;
    0.6945,  0.8376;
    0.7322,  0.7321;
    0.8377,  0.6756;
    0.8829,  0.5965;
    0.9771,  0.5663;
    1.0072,  0.4533;
    0.9884,  0.3215;
    0.9582,  0.1783;
    0.9394,  0.0615;
    0.9130, -0.0440;
    0.8942, -0.1118;
    0.8377, -0.1118;
    0.7736, -0.1042;
    0.7500, -0.1000;
    0.7326, -0.1326;
    0.7354, -0.1654;
    0.7382, -0.2272;
    0.7261, -0.2600;
    0.7083, -0.2797;
    0.6164,  0.0606;
    0.6000,  0.1000;
    0.5657,  0.1367;
    0.5299,  0.1471;
    0.4882,  0.1799;
    0.4360,  0.1799;
    0.3987,  0.1680;
    0.3376,  0.1650;
    0.2809,  0.1560;
    0.2436,  0.1277;
    0.2198,  0.0725;
    0.2824,  0.0815;
    0.3480,  0.1009;
    0.4000,  0.1000;
    0.4614,  0.0994;
    0.5000,  0.1000;
    0.5404,  0.0770;
    0.5806,  0.0576;
    0.6015,  0.0412;
    0.5114, -0.0819;
    0.4822, -0.0706;
    0.4390, -0.0408;
    0.4084, -0.0356;
    0.3831, -0.0356;
    0.3473, -0.0356;
    0.3189, -0.0400;
    0.2966, -0.0564;
    0.2653, -0.0669;
    0.2715, -0.0927;
    0.3000, -0.1000;
    0.3289, -0.1059;
    0.3555, -0.1134;
    0.3762, -0.1134;
    0.4095, -0.1192;
    0.4412, -0.1145;
    0.4759, -0.1035;
    0.1722, -0.1498;
    0.1780, -0.1903;
    0.1997, -0.2381;
    0.2388, -0.2700;
    0.2504, -0.3033;
    0.2461, -0.3555;
    0.2330, -0.3873;
    0.2026, -0.4177;
    0.1736, -0.4177;
    0.1403, -0.4177;
    0.1041, -0.4163;
    0.0826, -0.4167;
    0.0585, -0.4133;
    0.0356, -0.4121;
    0.0035, -0.4213;
   -0.0321, -0.4167;
   -0.0688, -0.4030;
   -0.0745, -0.3663;
   -0.0860, -0.3341;
   -0.0757, -0.2791;
   -0.0550, -0.2447;
   -0.0619, -0.0726;
   -0.0929, -0.0462;
   -0.1307, -0.0348;
   -0.1720, -0.0302;
   -0.2213, -0.0302;
   -0.2523, -0.0359;
   -0.2925, -0.0520;
   -0.3303, -0.0669;
   -0.3165, -0.0887;
   -0.3000, -0.1000;
   -0.2615, -0.1162;
   -0.2294, -0.1208;
   -0.1904, -0.1162;
   -0.1525, -0.1047;
   -0.1147, -0.0933;
   -0.0860, -0.0841;
   -0.0126,  0.1052;
   -0.0424,  0.1350;
   -0.0837,  0.1579;
   -0.1342,  0.1728;
   -0.1697,  0.1751;
   -0.2317,  0.1763;
   -0.2695,  0.1763;
   -0.3085,  0.1660;
   -0.3544,  0.1419;
   -0.3819,  0.1212;
   -0.4000,  0.1000;
   -0.4221,  0.0730;
   -0.4301,  0.0512;
   -0.4255,  0.0317;
   -0.3957,  0.0375;
   -0.3590,  0.0512;
   -0.3269,  0.0685;
   -0.2902,  0.0857;
   -0.2592,  0.1029;
   -0.2179,  0.1017;
   -0.1709,  0.0937;
   -0.1273,  0.0937;
   -0.0791,  0.0914;
   -0.0413,  0.0811;
   -0.0126,  0.0753;
   -0.0011,  0.0604;
   -0.1630, -0.6495;
   -0.1553, -0.6179;
   -0.1320, -0.5955;
   -0.0947, -0.5703;
   -0.0574, -0.5601;
   -0.0117, -0.5396;
    0.0312, -0.5452;
    0.0620, -0.5545;
    0.1000, -0.5500;
    0.1385, -0.5414;
    0.1730, -0.5433;
    0.2094, -0.5526;
    0.2420, -0.5629;
    0.2719, -0.5834;
    0.3000, -0.6000;
    0.3157, -0.6300;
    0.3250, -0.6534;
    0.3026, -0.6748;
    0.2877, -0.6860;
    0.2644, -0.6963;
    0.2327, -0.7065;
    0.1926, -0.7233;
    0.1665, -0.7326;
    0.1422, -0.7401;
    0.1077, -0.7373;
    0.0648, -0.7364;
    0.0387, -0.7345;
    0.0004, -0.7326;
   -0.0415, -0.7177;
   -0.0826, -0.7009;
   -0.1133, -0.6869;
   -0.1441, -0.6720;
   -0.1217, -0.6468;
   -0.0818, -0.6331;
   -0.0407, -0.6265;
    0.0113, -0.6291;
    0.0746, -0.6326;
    0.1292, -0.6249;
    0.1699, -0.6295;
    0.2133, -0.6326;
    0.2577, -0.6377;
    0.2897, -0.6460;
    0.6811, -0.5068;
    0.7102, -0.4800;
    0.7347, -0.4311;
    0.7523, -0.3607;
    0.7688, -0.2946;
    0.7823, -0.2331;
    0.7847, -0.1950;
    0.7815, -0.1237
];

% Inicialización
x1 = []; y1 = []; phi = [];
hx = []; hy = [];

x_actual = waypoints(1,1);
y_actual = waypoints(1,2);
phi_actual = 0;

x1(1) = x_actual;
y1(1) = y_actual;
phi(1) = phi_actual;
hx(1) = x_actual;
hy(1) = y_actual;

for i = 1:(size(waypoints,1)-1)
    p1 = waypoints(i,:);
    p2 = waypoints(i+1,:);

    dx = p2(1) - p1(1);
    dy = p2(2) - p1(2);
    dist = sqrt(dx^2 + dy^2);
    steps = round(dist / (v * ts));
    phi_actual = atan2(dy, dx);

    for k = 1:steps
        x_actual = x_actual + v*cos(phi_actual)*ts;
        y_actual = y_actual + v*sin(phi_actual)*ts;

        x1(end+1) = x_actual;
        y1(end+1) = y_actual;
        phi(end+1) = phi_actual;
        hx(end+1) = x_actual;
        hy(end+1) = y_actual;
    end
end

N = length(x1) - 1;
t = 0:ts:(N-1)*ts;
u = v * ones(1, N);
w = zeros(1, N);
for k = 2:length(phi)
    w(k-1) = (phi(k) - phi(k-1)) / ts;
end

%% Gráfica y animación
scale = 4;
figure;
axis equal; grid on; box on;
xlabel('x'); ylabel('y'); zlabel('z');
view(2);
axis([-1.5 1.5 -1.5 1.5 0 2]);

MobileRobot_5;
H1 = MobilePlot_4(x1(1), y1(1), phi(1), scale); hold on;
H2 = plot3(hx(1), hy(1), 0, 'b', 'lineWidth', 2);

for k = 1:N
    delete(H1); delete(H2);
    H1 = MobilePlot_4(x1(k), y1(k), phi(k), scale);
    H2 = plot3(hx(1:k), hy(1:k), zeros(1,k), 'b', 'lineWidth', 2);
    pause(ts);
end

%% Gráficas
figure;
subplot(211); plot(t, u, 'b', 'LineWidth', 2);
grid on; xlabel('Tiempo [s]'); ylabel('m/s'); legend('u');

subplot(212); plot(t, w, 'r', 'LineWidth', 2);
grid on; xlabel('Tiempo [s]'); ylabel('rad/s'); legend('w');
